<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NatuurDex - Scan Dieren</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a472a">
  <meta name="description" content="Scan en verzamel dieren met je telefoon">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .scan-section {
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .camera-container {
      position: relative;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #preview {
      max-width: 100%;
      display: none;
    }

    .camera-placeholder {
      color: #fff;
      text-align: center;
      padding: 40px;
    }

    #cameraInput {
      display: none;
    }

    .btn {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result {
      display: none;
      background: #fff;
      color: #333;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
      border-left: 5px solid #4CAF50;
    }

    .result.active {
      display: block;
      animation: slideIn 0.5s;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result h3 {
      color: #1a472a;
      margin-bottom: 10px;
      font-size: 1.5em;
    }

    .result-item {
      margin: 8px 0;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 5px;
    }

    .result-label {
      font-weight: bold;
      color: #666;
    }

    .badge-section {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      backdrop-filter: blur(5px);
    }

    .badge-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .badge-count {
      font-size: 1.2em;
      font-weight: bold;
    }

    .error {
      background: #f44336;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
      display: none;
    }

    .error.active {
      display: block;
    }

    .collection-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
    }

    .friend-code {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    .friend-code code {
      font-size: 1.5em;
      font-weight: bold;
      letter-spacing: 3px;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px 20px;
      border-radius: 5px;
      display: inline-block;
    }

    .collection-stats {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    .collection-stats h3 {
      margin-bottom: 10px;
    }

    .collection-stats .stat {
      font-size: 2em;
      font-weight: bold;
      color: #FFD700;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ü¶é NatuurDex</h1>
      <p class="subtitle">Scan en verzamel dieren!</p>
    </div>

    <!-- Collection Stats -->
    <div class="collection-stats" id="collectionStats">
      <h3>Je Collectie</h3>
      <div class="stat" id="collectionCount">0</div>
      <p>dieren gevangen</p>
    </div>

    <!-- Badges -->
    <div class="badge-section">
      <h2>üèÜ Badges</h2>
      <div class="badge-grid" id="badgeGrid">
        <div class="badge" id="badge-Bird">
          <div class="badge-icon">ü¶Ö</div>
          <div class="badge-count">0</div>
          <div>Vogels</div>
        </div>
        <div class="badge" id="badge-Mammal">
          <div class="badge-icon">ü¶Å</div>
          <div class="badge-count">0</div>
          <div>Zoogdieren</div>
        </div>
        <div class="badge" id="badge-Insect">
          <div class="badge-icon">ü¶ã</div>
          <div class="badge-count">0</div>
          <div>Insecten</div>
        </div>
        <div class="badge" id="badge-Fish">
          <div class="badge-icon">üêü</div>
          <div class="badge-count">0</div>
          <div>Vissen</div>
        </div>
      </div>
    </div>

    <!-- Scan Section -->
    <div class="scan-section">
      <h2>üì∏ Scan een dier</h2>
      
      <div class="camera-container" id="cameraContainer">
        <div class="camera-placeholder">
          <p>üëÜ Klik op "Open Camera" om te beginnen</p>
        </div>
        <img id="preview" alt="Preview">
      </div>

      <input type="file" id="cameraInput" accept="image/*" capture="environment">
      
      <button class="btn btn-primary" id="openCameraBtn">
        üì∑ Open Camera
      </button>

      <button class="btn btn-secondary" id="scanBtn" style="display: none;">
        üîç Scan Dier
      </button>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyseren van foto...</p>
      </div>

      <div class="error" id="error"></div>

      <div class="result" id="result">
        <h3 id="speciesName">-</h3>
        <div class="result-item">
          <span class="result-label">Wetenschappelijke naam:</span>
          <span id="scientificName">-</span>
        </div>
        <div class="result-item">
          <span class="result-label">Categorie:</span>
          <span id="category">-</span>
        </div>
        <div class="result-item">
          <span class="result-label">Betrouwbaarheid:</span>
          <span id="confidence">-</span>
        </div>
        <div class="result-item">
          <span class="result-label">Omschrijving:</span>
          <p id="description">-</p>
        </div>
        <button class="btn btn-primary" id="saveBtn">
          üíæ Opslaan in Dex
        </button>
      </div>
    </div>

    <!-- Collection Button -->
    <button class="btn collection-btn" id="collectionBtn">
      üìö Bekijk Volledige Collectie
    </button>
  </div>

  <script>
    // ============================================
    // CONFIGURATIE
    // ============================================
    
    const API_URL = 'https://pokedex-proxy.yoeran-appdev.workers.dev';

    // ============================================
    // GLOBAL STATE
    // ============================================
    
    let currentImage = null;
    let currentAnimal = null;
    let userId = localStorage.getItem('userId') || 'user_' + Date.now();
    localStorage.setItem('userId', userId);

    // ============================================
    // CAMERA FUNCTIONALITEIT
    // ============================================

    document.getElementById('openCameraBtn').addEventListener('click', () => {
      document.getElementById('cameraInput').click();
    });

    document.getElementById('cameraInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      compressImage(file).then(blob => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById('preview');
          preview.src = e.target.result;
          preview.style.display = 'block';
          
          document.querySelector('.camera-placeholder').style.display = 'none';
          document.getElementById('scanBtn').style.display = 'block';
          
          currentImage = e.target.result.split(',')[1];
        };
        reader.readAsDataURL(blob);
      });
    });

    function compressImage(file, maxWidth = 1024) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(blob);
            }, 'image/jpeg', 0.8);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ============================================
    // SCAN FUNCTIONALITEIT
    // ============================================

    document.getElementById('scanBtn').addEventListener('click', async () => {
      if (!currentImage) {
        showError('Geen foto geselecteerd');
        return;
      }

      showLoading(true);
      hideError();
      hideResult();

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'scanAnimal',
            image: currentImage,
            mimeType: 'image/jpeg'
          })
        });

        const data = await response.json();
        
        console.log('Vision API response:', data);
        
        if (data.success) {
          currentAnimal = data.animal;
          displayResult(data.animal);
          speakResult(data.animal);
        } else {
          showError(data.error || 'Er ging iets mis bij het scannen');
        }
      } catch (error) {
        showError('Kon geen verbinding maken met de API: ' + error.message);
      } finally {
        showLoading(false);
      }
    });

    // ============================================
    // OPSLAAN IN DEX
    // ============================================

    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (!currentAnimal) return;

      showLoading(true);

      let latitude = null;
      let longitude = null;

      if (navigator.geolocation) {
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
          latitude = position.coords.latitude;
          longitude = position.coords.longitude;
        } catch (e) {
          console.log('GPS niet beschikbaar:', e);
        }
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'saveAnimal',
            userId: userId,
            animal: currentAnimal,
            latitude: latitude,
            longitude: longitude
          })
        });

        const data = await response.json();
        
        if (data.success) {
          alert('üéâ Dier toegevoegd aan je Dex!');
          loadBadges();
          loadCollectionStats();
          
          // Reset for new scan
          hideResult();
          document.getElementById('preview').style.display = 'none';
          document.querySelector('.camera-placeholder').style.display = 'block';
          document.getElementById('scanBtn').style.display = 'none';
          currentImage = null;
          currentAnimal = null;
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('Kon dier niet opslaan: ' + error.message);
      } finally {
        showLoading(false);
      }
    });

    // ============================================
    // RESULTAAT WEERGAVE
    // ============================================

    function displayResult(animal) {
      document.getElementById('speciesName').textContent = animal.species;
      document.getElementById('scientificName').textContent = animal.scientificName;
      document.getElementById('category').textContent = animal.category;
      document.getElementById('confidence').textContent = 
        Math.round(animal.confidence * 100) + '%';
      
      let description = animal.description;
      if (animal.allLabels) {
        description += '\n\nGedetecteerde labels: ' + animal.allLabels;
      }
      document.getElementById('description').textContent = description;
      
      document.getElementById('result').classList.add('active');
    }

    function hideResult() {
      document.getElementById('result').classList.remove('active');
    }

    // ============================================
    // TEXT-TO-SPEECH
    // ============================================

    function speakResult(animal) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(
          `${animal.species}. ${animal.description}`
        );
        utterance.lang = 'nl-NL';
        utterance.rate = 0.9;
        utterance.pitch = 0.8;
        
        window.speechSynthesis.speak(utterance);
      }
    }

    // ============================================
    // BADGES LADEN
    // ============================================

    async function loadBadges() {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'getBadges',
            userId: userId
          })
        });

        const data = await response.json();
        
        if (data.success && data.badges) {
          updateBadgeDisplay(data.badges);
        }
      } catch (error) {
        console.error('Kon badges niet laden:', error);
      }
    }

    function updateBadgeDisplay(badges) {
      badges.forEach(badge => {
        const badgeEl = document.getElementById(`badge-${badge.category}`);
        if (badgeEl) {
          const countEl = badgeEl.querySelector('.badge-count');
          countEl.textContent = badge.count;
          
          if (badge.level > 0) {
            badgeEl.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
            badgeEl.style.color = '#000';
          }
        }
      });
    }

    // ============================================
    // COLLECTIE STATS
    // ============================================

    async function loadCollectionStats() {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'getCollection',
            userId: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          document.getElementById('collectionCount').textContent = data.count || 0;
        }
      } catch (error) {
        console.error('Kon collectie stats niet laden:', error);
      }
    }

    // ============================================
    // COLLECTIE BEKIJKEN
    // ============================================

    document.getElementById('collectionBtn').addEventListener('click', async () => {
      showLoading(true);
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'getCollection',
            userId: userId
          })
        });

        const data = await response.json();
        
        if (data.success) {
          if (data.animals.length === 0) {
            alert('Je collectie is nog leeg! Scan je eerste dier.');
          } else {
            const list = data.animals.map(a => 
              `ü¶é ${a.species} (${a.category})`
            ).join('\n');
            alert(`Je hebt ${data.animals.length} dieren verzameld!\n\n${list}`);
          }
        }
      } catch (error) {
        showError('Kon collectie niet laden: ' + error.message);
      } finally {
        showLoading(false);
      }
    });

    // ============================================
    // UI HELPERS
    // ============================================

    function showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('active');
      } else {
        loading.classList.remove('active');
      }
    }

    function showError(message) {
      const error = document.getElementById('error');
      error.textContent = message;
      error.classList.add('active');
    }

    function hideError() {
      document.getElementById('error').classList.remove('active');
    }

    // ============================================
    // INIT
    // ============================================

    loadBadges();
    loadCollectionStats();

    fetch(API_URL)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          console.log('‚úÖ API verbonden:', data.message);
        }
      })
      .catch(e => {
        console.error('‚ùå API niet bereikbaar:', e);
        showError('Kan geen verbinding maken met de API.');
      });
  </script>
</body>
</html>
